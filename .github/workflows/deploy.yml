name: Deploy to Azure VM

on:
  push:
    branches: [ "main" ]   # runs when you push to main
  workflow_dispatch:       # also allow manual run from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js (for building frontend)
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build frontend
      working-directory: frontend
      run: |
        npm ci
        npm run build

    - name: Upload files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_KEY }}
        source: |
          Backend/*
          frontend/dist/*
        target: /home/${{ secrets.VM_USER }}/app

    - name: Run deployment on VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_KEY }}
        script: |
          set -e
          echo "Starting deployment on $(date)"
          cd ~/app/Backend
          if [ -f package-lock.json ]; then npm ci --omit=dev; else npm install --omit=dev; fi
          pm2 restart app.js || pm2 start app.js
          pm2 save
          sudo rm -rf /var/www/html/*
          sudo cp -r ~/app/frontend/dist/* /var/www/html/
          sudo systemctl restart nginx
          echo "Deployment completed on $(date)"
